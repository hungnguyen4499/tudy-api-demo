# Há»‡ Thá»‘ng Quáº£n LÃ½ NgÆ°á»i DÃ¹ng & PhÃ¢n Quyá»n - Kiggle Platform

## ğŸ“‹ Tá»•ng Quan

Document nÃ y trÃ¬nh bÃ y vá» há»‡ thá»‘ng quáº£n lÃ½ ngÆ°á»i dÃ¹ng vÃ  phÃ¢n quyá»n cá»§a **Kiggle Platform** - má»™t marketplace káº¿t ná»‘i phá»¥ huynh vá»›i cÃ¡c dá»‹ch vá»¥ giÃ¡o dá»¥c (khÃ³a há»c, gia sÆ° táº¡i nhÃ ).

---

## ğŸ¯ BÃ i ToÃ¡n Quáº£n LÃ½ Cá»§a Kiggle

### Kiggle lÃ  gÃ¬?

**Kiggle** lÃ  má»™t **platform/marketplace** Ä‘Ã³ng vai trÃ² trung gian, káº¿t ná»‘i:

| BÃªn Cung Cáº¥p | BÃªn Sá»­ Dá»¥ng |
|--------------|-------------|
| **Organizations** (Trung tÃ¢m giÃ¡o dá»¥c, Ä‘á»‘i tÃ¡c) | **Parents** (Phá»¥ huynh) |
| **Tutors** (Gia sÆ° cÃ¡ nhÃ¢n hoáº·c thuá»™c tá»• chá»©c) | TÃ¬m khÃ³a há»c cho con |

### MÃ´ HÃ¬nh Kinh Doanh

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KIGGLE PLATFORM                       â”‚
â”‚              (Marketplace/Platform Owner)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORGANIZATION â”‚   â”‚ ORGANIZATION â”‚   â”‚ ORGANIZATION â”‚
â”‚  (Partner)   â”‚   â”‚  (Freelance) â”‚   â”‚  (Partner)   â”‚
â”‚              â”‚   â”‚              â”‚   â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Tutor   â”‚ â”‚   â”‚ â”‚  Tutor   â”‚ â”‚   â”‚ â”‚  Tutor   â”‚ â”‚
â”‚ â”‚  Tutor   â”‚ â”‚   â”‚ â”‚          â”‚ â”‚   â”‚ â”‚  Tutor   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚    PARENT    â”‚
                  â”‚  (Customer)  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¥ CÃ¡c Äá»‘i TÆ°á»£ng Trong Há»‡ Thá»‘ng

### 1. **Kiggle** (Platform Owner)

**Vai trÃ²:**
- Quáº£n lÃ½ toÃ n bá»™ platform
- Quáº£n lÃ½ táº¥t cáº£ organizations, tutors, parents
- Xem Ä‘Æ°á»£c táº¥t cáº£ dá»¯ liá»‡u (doanh thu, bookings, reviews)
- Cáº¥u hÃ¬nh há»‡ thá»‘ng (roles, permissions, menus)

**Äáº·c Ä‘iá»ƒm:**
- CÃ³ quyá»n truy cáº­p **GLOBAL** (toÃ n bá»™ dá»¯ liá»‡u)
- KhÃ´ng thuá»™c vá» báº¥t ká»³ organization nÃ o
- Quáº£n lÃ½ cÃ¡c Ä‘á»‘i tÃ¡c vÃ  ngÆ°á»i dÃ¹ng

---

### 2. **Organization** (Tá»• Chá»©c)

**Hai loáº¡i Organization:**

#### a) **Partner Organization** (Äá»‘i TÃ¡c)
- **VÃ­ dá»¥:** Trung tÃ¢m Anh ngá»¯ ABC, Trung tÃ¢m ToÃ¡n há»c XYZ
- **Äáº·c Ä‘iá»ƒm:**
  - Tá»• chá»©c Ä‘á»™c láº­p, cÃ³ giáº¥y phÃ©p kinh doanh
  - Tá»± quáº£n lÃ½ nhÃ¢n viÃªn (admin, staff)
  - Tá»± quáº£n lÃ½ tutors thuá»™c tá»• chá»©c
  - Tá»± quáº£n lÃ½ products (khÃ³a há»c, dá»‹ch vá»¥)
  - Chá»‰ tháº¥y dá»¯ liá»‡u cá»§a chÃ­nh mÃ¬nh

#### b) **Freelance Organization** (Tá»• Chá»©c Tá»± Táº¡o Cho Gia SÆ° Tá»± Do)
- **VÃ­ dá»¥:** Gia sÆ° Nguyá»…n VÄƒn A tá»± táº¡o "NhÃ³m Gia SÆ° Nguyá»…n VÄƒn A"
- **Äáº·c Ä‘iá»ƒm:**
  - Tá»± Ä‘á»™ng táº¡o khi tutor freelance Ä‘Äƒng kÃ½
  - Tutor Ä‘Ã³ lÃ  admin cá»§a organization nÃ y
  - CÃ³ thá»ƒ má»i thÃªm tutors khÃ¡c vÃ o (tÆ°Æ¡ng lai)
  - Quáº£n lÃ½ products vÃ  bookings cá»§a chÃ­nh mÃ¬nh
  - Chá»‰ tháº¥y dá»¯ liá»‡u cá»§a chÃ­nh mÃ¬nh

**Quyá»n Quáº£n LÃ½:**
- âœ… Tá»± quáº£n lÃ½ organization (thÃ´ng tin, Ä‘á»‹a chá»‰, logo)
- âœ… Tá»± quáº£n lÃ½ tutors thuá»™c organization
- âœ… Tá»± quáº£n lÃ½ products (khÃ³a há»c, dá»‹ch vá»¥)
- âœ… Tá»± quáº£n lÃ½ bookings tá»« parents
- âœ… Xem reports vÃ  analytics cá»§a chÃ­nh mÃ¬nh
- âŒ KhÃ´ng thá»ƒ xem dá»¯ liá»‡u cá»§a organizations khÃ¡c
- âŒ KhÃ´ng thá»ƒ quáº£n lÃ½ parents (chá»‰ Kiggle má»›i cÃ³ quyá»n nÃ y)

---

### 3. **Tutor** (Gia SÆ°)

**Hai loáº¡i Tutor:**

#### a) **Tutor Thuá»™c Partner Organization**
- **VÃ­ dá»¥:** Gia sÆ° lÃ m viá»‡c cho Trung tÃ¢m Anh ngá»¯ ABC
- **Äáº·c Ä‘iá»ƒm:**
  - Thuá»™c vá» má»™t Partner Organization cá»¥ thá»ƒ
  - ÄÆ°á»£c organization quáº£n lÃ½
  - Chá»‰ tháº¥y bookings/products cá»§a organization Ä‘Ã³
  - KhÃ´ng thá»ƒ táº¡o organization má»›i

#### b) **Freelance Tutor** (Gia SÆ° Tá»± Do)
- **VÃ­ dá»¥:** Gia sÆ° Ä‘á»™c láº­p, khÃ´ng thuá»™c tá»• chá»©c nÃ o
- **Äáº·c Ä‘iá»ƒm:**
  - Tá»± Ä‘á»™ng cÃ³ má»™t Freelance Organization
  - LÃ  admin cá»§a organization Ä‘Ã³
  - Tá»± quáº£n lÃ½ products vÃ  bookings cá»§a chÃ­nh mÃ¬nh
  - CÃ³ thá»ƒ má»i tutors khÃ¡c vÃ o (tÆ°Æ¡ng lai)

**Quyá»n:**
- âœ… Xem vÃ  quáº£n lÃ½ bookings cá»§a mÃ¬nh
- âœ… Chat vá»›i parents
- âœ… Xem lá»‹ch há»c
- âœ… Cáº­p nháº­t profile
- âŒ KhÃ´ng thá»ƒ xem dá»¯ liá»‡u cá»§a tutors khÃ¡c (trá»« khi cÃ¹ng organization)

---

### 4. **Parent** (Phá»¥ Huynh)

**Vai trÃ²:**
- **End User / Customer** cá»§a marketplace
- TÃ¬m kiáº¿m vÃ  Ä‘Äƒng kÃ½ khÃ³a há»c cho con
- Äáº·t lá»‹ch há»c vá»›i tutors/organizations
- Thanh toÃ¡n vÃ  Ä‘Ã¡nh giÃ¡ dá»‹ch vá»¥

**Äáº·c Ä‘iá»ƒm:**
- KhÃ´ng thuá»™c vá» organization nÃ o
- CÃ³ thá»ƒ xem **Táº¤T Cáº¢** products trÃªn marketplace (khÃ´ng bá»‹ giá»›i háº¡n bá»Ÿi organization)
- Chá»‰ tháº¥y bookings cá»§a chÃ­nh mÃ¬nh
- Chá»‰ quáº£n lÃ½ thÃ´ng tin cá»§a chÃ­nh mÃ¬nh vÃ  con cÃ¡i

**Quyá»n:**
- âœ… Xem táº¥t cáº£ products (marketplace view)
- âœ… Äáº·t booking vá»›i báº¥t ká»³ tutor/organization nÃ o
- âœ… Chat vá»›i tutors/organizations
- âœ… Xem lá»‹ch há»c cá»§a con
- âœ… Thanh toÃ¡n vÃ  Ä‘Ã¡nh giÃ¡
- âœ… Quáº£n lÃ½ thÃ´ng tin cÃ¡ nhÃ¢n vÃ  con cÃ¡i
- âŒ KhÃ´ng thá»ƒ quáº£n lÃ½ tutors/organizations
- âŒ KhÃ´ng thá»ƒ xem bookings cá»§a parents khÃ¡c

---

## ğŸ” Há»‡ Thá»‘ng PhÃ¢n Quyá»n (Authorization System)

Há»‡ thá»‘ng phÃ¢n quyá»n cá»§a Kiggle sá»­ dá»¥ng **2 lá»›p báº£o vá»‡**:

### 1. **RBAC** (Role-Based Access Control) - "NgÆ°á»i dÃ¹ng CÃ“ THá»‚ lÃ m gÃ¬?"

**CÃ¢u há»i:** "User nÃ y cÃ³ quyá»n thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y khÃ´ng?"

**VÃ­ dá»¥:**
- âœ… `PARTNER_ADMIN` cÃ³ quyá»n `product.create` â†’ CÃ³ thá»ƒ táº¡o khÃ³a há»c
- âŒ `PARTNER_STAFF` khÃ´ng cÃ³ quyá»n `product.delete` â†’ KhÃ´ng thá»ƒ xÃ³a khÃ³a há»c

**CÃ¡c thÃ nh pháº§n:**

#### a) **Role** (Vai TrÃ²)
- Äá»‹nh nghÄ©a vai trÃ² cá»§a user trong há»‡ thá»‘ng
- **VÃ­ dá»¥:** `KIGGLE_ADMIN`, `PARTNER_ADMIN`, `PARTNER_STAFF`, `TUTOR`, `PARENT`

#### b) **Permission** (Quyá»n)
- Äá»‹nh nghÄ©a cÃ¡c hÃ nh Ä‘á»™ng cá»¥ thá»ƒ
- **Format:** `{resource}.{action}`
- **VÃ­ dá»¥:**
  - `product.create` - Táº¡o khÃ³a há»c
  - `product.read` - Xem khÃ³a há»c
  - `product.update` - Cáº­p nháº­t khÃ³a há»c
  - `product.delete` - XÃ³a khÃ³a há»c
  - `booking.approve` - Duyá»‡t booking
  - `user.manage` - Quáº£n lÃ½ ngÆ°á»i dÃ¹ng

#### c) **RolePermission** (GÃ¡n Quyá»n Cho Vai TrÃ²)
- Má»™t Role cÃ³ nhiá»u Permissions
- **VÃ­ dá»¥:**
  ```
  PARTNER_ADMIN cÃ³ cÃ¡c quyá»n:
  - product.create
  - product.read
  - product.update
  - product.delete
  - booking.manage
  ```

#### d) **UserRole** (GÃ¡n Vai TrÃ² Cho NgÆ°á»i DÃ¹ng)
- Má»™t User cÃ³ thá»ƒ cÃ³ nhiá»u Roles
- **VÃ­ dá»¥:**
  ```
  User "Nguyá»…n VÄƒn A" cÃ³ roles:
  - PARTNER_ADMIN (cá»§a Organization ABC)
  - TUTOR (cá»§a Organization ABC)
  ```

#### e) **Menu** (Menu/Giao Diá»‡n)
- Äá»‹nh nghÄ©a cÃ¡c pháº§n tá»­ UI (sidebar menu, button, tab)
- **3 loáº¡i:**
  - `MENU` - Menu sidebar (vÃ­ dá»¥: "Products", "Bookings")
  - `BUTTON` - NÃºt hÃ nh Ä‘á»™ng (vÃ­ dá»¥: "ThÃªm", "XÃ³a", "Xuáº¥t Excel")
  - `TAB` - Tab navigation (vÃ­ dá»¥: "ThÃ´ng tin cÆ¡ báº£n", "CÃ i Ä‘áº·t")

#### f) **RoleMenu** (GÃ¡n Menu Cho Vai TrÃ²)
- Má»™t Role cÃ³ nhiá»u Menus
- **VÃ­ dá»¥:**
  ```
  PARTNER_ADMIN tháº¥y cÃ¡c menu:
  - menu.products
  - menu.bookings
  - btn.product.create
  - btn.product.delete
  ```

**Luá»“ng Hoáº¡t Äá»™ng:**

```
User Ä‘Äƒng nháº­p
    â”‚
    â–¼
JWT Token chá»©a userId
    â”‚
    â–¼
Load UserRoles tá»« database
    â”‚
    â–¼
Load Permissions tá»« cÃ¡c Roles
    â”‚
    â–¼
Load Menus tá»« cÃ¡c Roles
    â”‚
    â–¼
Cache vÃ o Redis (5 phÃºt)
    â”‚
    â–¼
Sá»­ dá»¥ng trong request:
- PermissionsGuard: Kiá»ƒm tra quyá»n
- MenuService: Render UI
```

---

### 2. **DataScope** (Pháº¡m Vi Dá»¯ Liá»‡u) - "NgÆ°á»i dÃ¹ng THáº¤Y Ä‘Æ°á»£c dá»¯ liá»‡u nÃ o?"

**CÃ¢u há»i:** "User nÃ y cÃ³ thá»ƒ xem dá»¯ liá»‡u cá»§a ai?"

**3 má»©c pháº¡m vi:**

#### a) **GLOBAL** (ToÃ n Cá»¥c)
- **Roles:** `KIGGLE_ADMIN`, `KIGGLE_STAFF`
- **Quyá»n truy cáº­p:** Táº¥t cáº£ dá»¯ liá»‡u cá»§a táº¥t cáº£ organizations
- **VÃ­ dá»¥:**
  - Xem táº¥t cáº£ products cá»§a táº¥t cáº£ organizations
  - Xem táº¥t cáº£ bookings
  - Xem reports tá»•ng há»£p

#### b) **ORGANIZATION** (Tá»• Chá»©c)
- **Roles:** `PARTNER_ADMIN`, `PARTNER_STAFF`, `TUTOR`
- **Quyá»n truy cáº­p:** Chá»‰ dá»¯ liá»‡u cá»§a organization mÃ  user thuá»™c vá»
- **VÃ­ dá»¥:**
  - `PARTNER_ADMIN` cá»§a Organization ABC chá»‰ tháº¥y:
    - Products cá»§a Organization ABC
    - Bookings cá»§a Organization ABC
    - Tutors thuá»™c Organization ABC
    - Reports cá»§a Organization ABC
  - KhÃ´ng tháº¥y dá»¯ liá»‡u cá»§a Organization XYZ

#### c) **USER** (CÃ¡ NhÃ¢n)
- **Roles:** `PARENT`
- **Quyá»n truy cáº­p:** Chá»‰ dá»¯ liá»‡u cá»§a chÃ­nh mÃ¬nh
- **VÃ­ dá»¥:**
  - `PARENT` chá»‰ tháº¥y:
    - Bookings cá»§a chÃ­nh mÃ¬nh
    - Children cá»§a chÃ­nh mÃ¬nh
    - Reviews cá»§a chÃ­nh mÃ¬nh
  - **NHÆ¯NG** cÃ³ thá»ƒ xem **Táº¤T Cáº¢** products trÃªn marketplace (khÃ´ng bá»‹ giá»›i háº¡n)

**LÆ°u Ã½ Ä‘áº·c biá»‡t cho PARENT:**
- Marketplace view: Xem **Táº¤T Cáº¢** products (khÃ´ng filter)
- Personal data: Chá»‰ tháº¥y dá»¯ liá»‡u cá»§a chÃ­nh mÃ¬nh (bookings, children)

---

## ğŸ“Š SÆ¡ Äá»“ ERD (Entity Relationship Diagram)

### 1. User & Profile Models

SÆ¡ Ä‘á»“ quan há»‡ giá»¯a cÃ¡c báº£ng User, Parent, Tutor, Organization vÃ  OrganizationMember:

```mermaid
erDiagram
    User ||--o| Parent : "has"
    User ||--o| Tutor : "has"
    User ||--o| OrganizationMember : "has"
    Parent ||--|{ Child : "manages"
    Tutor }o--|| Organization : "belongs to"
    OrganizationMember }o--|| Organization : "belongs to"
    Tutor ||--o| OrganizationMember : "is membership record"
    
    User {
        int id PK
        string email UK
        string phone UK
        string passwordHash
        enum status
        datetime createdAt
        datetime updatedAt
        datetime deletedAt
    }
    
    Parent {
        int id PK
        int userId FK
        string referralCode UK
        int referredBy FK
    }
    
    Child {
        int id PK
        int parentId FK
        string firstName
        string lastName
        datetime dateOfBirth
        int gradeLevel
    }
    
    Tutor {
        int id PK
        int userId FK
        int organizationId FK
        boolean isFreelance
        enum applicationStatus
        decimal averageRating
        int totalSessions
        int completedSessions
    }
    
    Organization {
        int id PK
        enum type
        string name
        string slug UK
        enum status
        decimal averageRating
    }
    
    OrganizationMember {
        int id PK
        int userId FK
        int organizationId FK
        datetime joinedAt
    }
```

**Äiá»ƒm quan trá»ng:**
- `User` lÃ  báº£ng trung tÃ¢m vá»›i 3 loáº¡i profile: Parent, Tutor, OrganizationMember
- `Parent` quáº£n lÃ½ nhiá»u `Child`
- `Tutor` luÃ´n thuá»™c vá» má»™t `Organization` (Partner hoáº·c Freelance)
- `OrganizationMember` theo dÃµi thÃ nh viÃªn cá»§a organization (má»™t user thuá»™c tá»‘i Ä‘a má»™t organization)
- PhÃ¢n quyá»n Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi cÃ¡c báº£ng RBAC (xem pháº§n 2)

---

### 2. RBAC (Role-Based Access Control) Models

SÆ¡ Ä‘á»“ quan há»‡ giá»¯a cÃ¡c báº£ng RBAC: User, Role, Permission, Menu vÃ  cÃ¡c báº£ng liÃªn káº¿t:

```mermaid
erDiagram
    User ||--o{ UserRole : "has"
    Role ||--o{ UserRole : "assigned to"
    Role ||--o{ RolePermission : "has"
    Permission ||--o{ RolePermission : "granted to"
    Role ||--o{ RoleMenu : "grants menu"
    Menu ||--o{ RoleMenu : "visible to"
    
    User {
        int id PK
        string email UK
        string phone UK
        enum status
    }
    
    Role {
        int id PK
        string name UK
        string displayName
        enum dataScope
        boolean isSystem
    }
    
    UserRole {
        int id PK
        int userId FK
        int roleId FK
        datetime assignedAt
        datetime expiresAt "nullable"
    }
    
    Permission {
        int id PK
        string code UK
        string resource
        string action
        string displayName
    }
    
    RolePermission {
        int id PK
        int roleId FK
        int permissionId FK
    }
    
    Menu {
        int id PK
        string code UK
        enum type
        string path
        string component
        int parentId FK
        int permissionId FK "nullable"
    }
    
    RoleMenu {
        int id PK
        int roleId FK
        int menuId FK
    }
```

**Äiá»ƒm quan trá»ng:**
- âœ… **PhÃ¢n quyá»n chi tiáº¿t**: `product.create`, `booking.approve`, `report.export`
- âœ… **Data scope theo role**: `Role.dataScope` xÃ¡c Ä‘á»‹nh GLOBAL / ORGANIZATION / USER
- âœ… **UserRole lÃ  nguá»“n sá»± tháº­t duy nháº¥t**: GÃ¡n role cho user (khÃ´ng cÃ³ field organizationId)
- âœ… **TÃ­ch há»£p Menu**: Roles kiá»ƒm soÃ¡t quyá»n API + hiá»ƒn thá»‹ UI
- âœ… **Cache**: Permissions/menu codes Ä‘Æ°á»£c load má»™t láº§n vÃ  cache trong Redis

**Äá»‹nh dáº¡ng Permission:** `{resource}.{action}` (vÃ­ dá»¥: `product.create`, `booking.update`)

**Luá»“ng dá»¯ liá»‡u:**
```
User â†’ UserRole â†’ Role â†’ RolePermission â†’ Permission
                  â†“
              RoleMenu â†’ Menu
```

---

## ğŸ”„ Má»‘i Quan Há»‡ Giá»¯a CÃ¡c Äá»‘i TÆ°á»£ng

### SÆ¡ Äá»“ Quan Há»‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         KIGGLE                              â”‚
â”‚                    (Platform Owner)                         â”‚
â”‚                                                             â”‚
â”‚  Roles: KIGGLE_ADMIN, KIGGLE_STAFF                         â”‚
â”‚  DataScope: GLOBAL (tháº¥y táº¥t cáº£)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Quáº£n lÃ½
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ORGANIZATION â”‚   â”‚ ORGANIZATION â”‚   â”‚ ORGANIZATION â”‚
â”‚   (Partner)  â”‚   â”‚  (Freelance)  â”‚   â”‚   (Partner)  â”‚
â”‚              â”‚   â”‚              â”‚   â”‚              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Tutor   â”‚ â”‚   â”‚ â”‚  Tutor   â”‚ â”‚   â”‚ â”‚  Tutor   â”‚ â”‚
â”‚ â”‚  Tutor   â”‚ â”‚   â”‚ â”‚          â”‚ â”‚   â”‚ â”‚  Tutor   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚   â”‚              â”‚   â”‚              â”‚
â”‚ Roles:       â”‚   â”‚ Roles:       â”‚   â”‚ Roles:       â”‚
â”‚ PARTNER_ADMINâ”‚   â”‚ TUTOR        â”‚   â”‚ PARTNER_ADMINâ”‚
â”‚ PARTNER_STAFFâ”‚   â”‚ (tá»± Ä‘á»™ng lÃ   â”‚   â”‚ PARTNER_STAFFâ”‚
â”‚ TUTOR        â”‚   â”‚  admin cá»§a   â”‚   â”‚ TUTOR        â”‚
â”‚              â”‚   â”‚  org nÃ y)    â”‚   â”‚              â”‚
â”‚ DataScope:   â”‚   â”‚ DataScope:   â”‚   â”‚ DataScope:   â”‚
â”‚ ORGANIZATION â”‚   â”‚ ORGANIZATION â”‚   â”‚ ORGANIZATION â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ Sá»­ dá»¥ng dá»‹ch vá»¥
                          â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚     PARENT    â”‚
                  â”‚   (Customer)  â”‚
                  â”‚               â”‚
                  â”‚ Role: PARENT  â”‚
                  â”‚ DataScope:    â”‚
                  â”‚ USER          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Báº£ng TÃ³m Táº¯t Quan Há»‡

| Äá»‘i TÆ°á»£ng | Thuá»™c Vá» | Roles | DataScope | Quyá»n Truy Cáº­p Dá»¯ Liá»‡u |
|-----------|----------|-------|-----------|------------------------|
| **Kiggle Admin** | KhÃ´ng thuá»™c org nÃ o | `KIGGLE_ADMIN` | `GLOBAL` | Táº¥t cáº£ dá»¯ liá»‡u |
| **Kiggle Staff** | KhÃ´ng thuá»™c org nÃ o | `KIGGLE_STAFF` | `GLOBAL` | Táº¥t cáº£ dá»¯ liá»‡u |
| **Partner Admin** | Partner Organization | `PARTNER_ADMIN` | `ORGANIZATION` | Chá»‰ dá»¯ liá»‡u cá»§a org mÃ¬nh |
| **Partner Staff** | Partner Organization | `PARTNER_STAFF` | `ORGANIZATION` | Chá»‰ dá»¯ liá»‡u cá»§a org mÃ¬nh |
| **Tutor (Partner)** | Partner Organization | `TUTOR` | `ORGANIZATION` | Chá»‰ dá»¯ liá»‡u cá»§a org mÃ¬nh |
| **Tutor (Freelance)** | Freelance Organization (tá»± táº¡o) | `TUTOR` | `ORGANIZATION` | Chá»‰ dá»¯ liá»‡u cá»§a org mÃ¬nh |
| **Parent** | KhÃ´ng thuá»™c org nÃ o | `PARENT` | `USER` | Dá»¯ liá»‡u cÃ¡ nhÃ¢n + Táº¥t cáº£ products (marketplace) |

---

## ğŸ’¡ VÃ­ Dá»¥ Thá»±c Táº¿

### VÃ­ Dá»¥ 1: Partner Admin Táº¡o KhÃ³a Há»c

**TÃ¬nh huá»‘ng:**
- User: Nguyá»…n VÄƒn A
- Role: `PARTNER_ADMIN`
- Organization: Trung tÃ¢m Anh ngá»¯ ABC

**Luá»“ng xá»­ lÃ½:**

1. **RBAC Check:**
   - User cÃ³ quyá»n `product.create`? âœ… CÃ³ (vÃ¬ `PARTNER_ADMIN` cÃ³ quyá»n nÃ y)

2. **DataScope Check:**
   - User thuá»™c Organization nÃ o? â†’ Organization ABC
   - Khi táº¡o product, tá»± Ä‘á»™ng gÃ¡n `organizationId = Organization ABC`
   - User chá»‰ tháº¥y products cá»§a Organization ABC

3. **Káº¿t quáº£:**
   - âœ… Táº¡o product thÃ nh cÃ´ng
   - Product Ä‘Æ°á»£c gÃ¡n cho Organization ABC
   - User chá»‰ tháº¥y products cá»§a Organization ABC (khÃ´ng tháº¥y cá»§a Organization XYZ)

---

### VÃ­ Dá»¥ 2: Parent Xem KhÃ³a Há»c

**TÃ¬nh huá»‘ng:**
- User: Phá»¥ huynh Nguyá»…n Thá»‹ B
- Role: `PARENT`

**Luá»“ng xá»­ lÃ½:**

1. **Marketplace View:**
   - Parent xem danh sÃ¡ch products
   - **KHÃ”NG** filter theo organization
   - Tháº¥y **Táº¤T Cáº¢** products cá»§a táº¥t cáº£ organizations

2. **Personal Data:**
   - Parent xem bookings cá»§a mÃ¬nh
   - **CHá»ˆ** tháº¥y bookings mÃ  mÃ¬nh Ä‘Ã£ Ä‘áº·t
   - KhÃ´ng tháº¥y bookings cá»§a parents khÃ¡c

3. **Káº¿t quáº£:**
   - âœ… Xem Ä‘Æ°á»£c táº¥t cáº£ products (marketplace)
   - âœ… Chá»‰ tháº¥y bookings cá»§a chÃ­nh mÃ¬nh

---

### VÃ­ Dá»¥ 3: Tutor Freelance Quáº£n LÃ½ Bookings

**TÃ¬nh huá»‘ng:**
- User: Gia sÆ° Tráº§n VÄƒn C
- Role: `TUTOR`
- Organization: Freelance Organization (tá»± táº¡o)

**Luá»“ng xá»­ lÃ½:**

1. **RBAC Check:**
   - User cÃ³ quyá»n `booking.read`? âœ… CÃ³ (vÃ¬ `TUTOR` cÃ³ quyá»n nÃ y)

2. **DataScope Check:**
   - User thuá»™c Organization nÃ o? â†’ Freelance Organization cá»§a chÃ­nh mÃ¬nh
   - Chá»‰ tháº¥y bookings cá»§a Freelance Organization nÃ y

3. **Káº¿t quáº£:**
   - âœ… Xem Ä‘Æ°á»£c bookings cá»§a chÃ­nh mÃ¬nh
   - âŒ KhÃ´ng tháº¥y bookings cá»§a tutors khÃ¡c

---

## ğŸ¨ Menu System (Há»‡ Thá»‘ng Menu)

### Má»¥c ÄÃ­ch

Menu system cho phÃ©p **quáº£n lÃ½ giao diá»‡n ngÆ°á»i dÃ¹ng Ä‘á»™ng** mÃ  khÃ´ng cáº§n sá»­a code.

### CÃ¡c Loáº¡i Menu

| Loáº¡i | MÃ´ Táº£ | VÃ­ Dá»¥ |
|------|-------|-------|
| **MENU** | Menu sidebar | "Sáº£n Pháº©m", "Äáº·t Lá»‹ch", "BÃ¡o CÃ¡o" |
| **BUTTON** | NÃºt hÃ nh Ä‘á»™ng | "ThÃªm", "XÃ³a", "Xuáº¥t Excel", "Duyá»‡t" |
| **TAB** | Tab navigation | "ThÃ´ng Tin CÆ¡ Báº£n", "CÃ i Äáº·t", "Lá»‹ch Sá»­" |

### VÃ­ Dá»¥ Menu Hierarchy

```
menu.products (MENU)
â”œâ”€â”€ btn.product.create (BUTTON)
â”œâ”€â”€ btn.product.edit (BUTTON)
â”œâ”€â”€ btn.product.delete (BUTTON)
â””â”€â”€ btn.product.export (BUTTON)

menu.bookings (MENU)
â”œâ”€â”€ btn.booking.approve (BUTTON)
â”œâ”€â”€ btn.booking.reject (BUTTON)
â””â”€â”€ tab.booking.details (TAB)
    â”œâ”€â”€ tab.booking.info (TAB)
    â””â”€â”€ tab.booking.payment (TAB)
```

### GÃ¡n Menu Cho Role

- `PARTNER_ADMIN` tháº¥y:
  - `menu.products`
  - `menu.bookings`
  - `btn.product.create`
  - `btn.product.delete`
  - `btn.booking.approve`

- `PARTNER_STAFF` tháº¥y:
  - `menu.products`
  - `menu.bookings`
  - `btn.product.create` (khÃ´ng cÃ³ `btn.product.delete`)

### Lá»£i Ãch

- âœ… Admin cÃ³ thá»ƒ thÃªm/xÃ³a menu mÃ  khÃ´ng cáº§n sá»­a code frontend
- âœ… Má»—i role tháº¥y UI khÃ¡c nhau
- âœ… Menu cÃ³ thá»ƒ link vá»›i Permission (kiá»ƒm tra quyá»n trÆ°á»›c khi hiá»ƒn thá»‹)

---

## ğŸ”’ Báº£o Máº­t & Kiá»ƒm SoÃ¡t Truy Cáº­p

### Lá»›p Báº£o Vá»‡ 1: RBAC (PermissionsGuard)

**Kiá»ƒm tra:** "User cÃ³ quyá»n thá»±c hiá»‡n hÃ nh Ä‘á»™ng nÃ y khÃ´ng?"

```typescript
@RequirePermission('product.create')
createProduct() {
  // Chá»‰ user cÃ³ quyá»n product.create má»›i vÃ o Ä‘Æ°á»£c Ä‘Ã¢y
}
```

### Lá»›p Báº£o Vá»‡ 2: DataScope (DataScopeContext)

**Kiá»ƒm tra:** "User cÃ³ thá»ƒ xem/sá»­a dá»¯ liá»‡u nÃ y khÃ´ng?"

```typescript
// Tá»± Ä‘á»™ng filter theo organization
const products = await prisma.product.findMany({
  where: {
    ...dataScopeContext.getOrganizationFilter(), // Tá»± Ä‘á»™ng thÃªm organizationId
    status: 'ACTIVE',
  },
});
```

### Káº¿t Há»£p Cáº£ Hai

```typescript
@RequirePermission('product.update') // RBAC: Kiá»ƒm tra quyá»n
async updateProduct(id: number, data: UpdateProductDto) {
  const product = await this.repository.findById(id);
  
  // DataScope: Kiá»ƒm tra user cÃ³ thá»ƒ truy cáº­p product nÃ y khÃ´ng
  if (!dataScopeContext.canAccessResource(product)) {
    throw new ForbiddenException();
  }
  
  return this.repository.update(id, data);
}
```

---

## ğŸ“Š TÃ³m Táº¯t

### Äiá»ƒm Máº¡nh Cá»§a Há»‡ Thá»‘ng

1. **Linh Hoáº¡t:**
   - Há»— trá»£ cáº£ Partner Organization vÃ  Freelance Tutor
   - Dá»… dÃ ng thÃªm roles/permissions má»›i

2. **Báº£o Máº­t:**
   - 2 lá»›p báº£o vá»‡: RBAC + DataScope
   - Tá»± Ä‘á»™ng filter dá»¯ liá»‡u theo organization
   - KhÃ´ng thá»ƒ truy cáº­p dá»¯ liá»‡u cá»§a organizations khÃ¡c

3. **Dá»… Quáº£n LÃ½:**
   - Admin cÃ³ thá»ƒ quáº£n lÃ½ roles/permissions/menus qua UI
   - KhÃ´ng cáº§n sá»­a code khi thay Ä‘á»•i quyá»n

4. **Hiá»‡u Suáº¥t:**
   - Cache permissions/menus vÃ o Redis (5 phÃºt)
   - Giáº£m sá»‘ lÆ°á»£ng query database

### CÃ¡c ThÃ nh Pháº§n ChÃ­nh

| ThÃ nh Pháº§n | Má»¥c ÄÃ­ch |
|------------|----------|
| **User** | NgÆ°á»i dÃ¹ng trong há»‡ thá»‘ng |
| **Role** | Vai trÃ² cá»§a user (KIGGLE_ADMIN, PARTNER_ADMIN, ...) |
| **Permission** | Quyá»n cá»¥ thá»ƒ (product.create, booking.approve, ...) |
| **Menu** | Pháº§n tá»­ UI (menu, button, tab) |
| **Organization** | Tá»• chá»©c (Partner hoáº·c Freelance) |
| **DataScope** | Pháº¡m vi dá»¯ liá»‡u (GLOBAL, ORGANIZATION, USER) |

---

## ğŸ“ Káº¿t Luáº­n

Há»‡ thá»‘ng phÃ¢n quyá»n cá»§a Kiggle Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ:

1. âœ… Há»— trá»£ mÃ´ hÃ¬nh marketplace Ä‘a tá»• chá»©c
2. âœ… Báº£o máº­t dá»¯ liá»‡u giá»¯a cÃ¡c organizations
3. âœ… Linh hoáº¡t trong viá»‡c quáº£n lÃ½ quyá»n vÃ  giao diá»‡n
4. âœ… Dá»… dÃ ng má»Ÿ rá»™ng khi cÃ³ thÃªm roles/permissions má»›i
5. âœ… Hiá»‡u suáº¥t cao vá»›i caching vÃ  tá»‘i Æ°u query

Há»‡ thá»‘ng nÃ y Ä‘áº£m báº£o:
- **Kiggle** quáº£n lÃ½ toÃ n bá»™ platform
- **Organizations** tá»± quáº£n lÃ½ dá»¯ liá»‡u cá»§a mÃ¬nh
- **Tutors** chá»‰ tháº¥y dá»¯ liá»‡u cá»§a organization mÃ¬nh
- **Parents** xem Ä‘Æ°á»£c táº¥t cáº£ products nhÆ°ng chá»‰ quáº£n lÃ½ dá»¯ liá»‡u cÃ¡ nhÃ¢n

