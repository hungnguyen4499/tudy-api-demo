---
description: NestJS Rules - NestJS framework specific standards
globs: ["**/*.ts"]
alwaysApply: false
---

# NestJS Rules

## Project Structure
- common/: shared utilities, decorators, dto, exceptions, filters, guards
- config/: config classes (app.config.ts, database.config.ts)
- infrastructure/: external services (database/, redis/, file/)
- modules/{name}/: controllers/, services/, repositories/, dto/, entities/, mappers/

## Layered Architecture
- Layers: Controller → Service → Repository → Database
- Request: Request → Validation → Guard → Controller → Service → Repository → DB
- Response: DB → Repository (Entity) → Service (Response DTO) → Controller → Client
- Dependencies flow downward only, never skip layers

## Layer Responsibilities
- Controller: HTTP only, thin, no business logic, call service
- Service: Business rules, validation, transactions, use mapper for Entity → DTO
- Repository: DB queries only, return Entity (not DB model), use mapper for DB → Entity
- Entity: Domain model, business methods, computed properties
- Mapper: Convert between layers (DB ↔ Entity ↔ DTO)

## Naming
- Module: UsersModule, Service: UsersService, Controller: UsersController
- Repository: UsersRepository, Guard: JwtAuthGuard
- Entity: User → user.entity.ts
- Mapper: UserMapper → user.mapper.ts
- Request DTO: CreateUserRequest → create-user-request.dto.ts
- Response DTO: UserResponse → user-response.dto.ts

## Dependency Injection
- Constructor injection with private readonly
- Use @Inject('TOKEN') for interface injection

## Validation
- Global ValidationPipe: whitelist, forbidNonWhitelisted, transform
- class-validator decorators on DTOs
- @ApiProperty/@ApiPropertyOptional on DTO properties

## Exception Handling
- Three-tier: BusinessExceptionFilter → HttpExceptionFilter → AllExceptionsFilter
- Use BusinessException(ErrorCodes.XXX) in service layers
- ErrorCode: { code, message, httpStatus }, create new ErrorCode if not exists

## Response Pattern
- Result.success(data) for success
- Format: { code, message, data }

## Guards & Decorators
- @CurrentUser() for user extraction
- @Roles() + RolesGuard for authorization
- @Public() for public routes
- @RequirePermission() + PermissionsGuard for authorization

## Swagger
- @ApiTags, @ApiOperation on controllers
- @ApiProperty on DTOs
- Skip @ApiResponse, @HttpCode (keep controllers thin)

## Logging
- Logger(ClassName.name)
- log(), warn(), error() with context
