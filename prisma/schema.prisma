// Prisma Schema for KIGGLE Platform
// Redesigned database schema for the new business model

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODELS
// ============================================

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  phone        String?  @unique
  passwordHash String   @map("password_hash")
  role         UserRole

  firstName   String    @map("first_name")
  lastName    String    @map("last_name")
  avatarUrl   String?   @map("avatar_url")
  gender      Gender?
  dateOfBirth DateTime? @map("date_of_birth")

  address  String?
  city     String?
  district String?
  ward     String?
  lat      Decimal? @db.Decimal(10, 8)
  lng      Decimal? @db.Decimal(11, 8)

  status        UserStatus @default(ACTIVE)
  emailVerified Boolean    @default(false) @map("email_verified")
  phoneVerified Boolean    @default(false) @map("phone_verified")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  parent             Parent?
  tutor              Tutor?
  organizationMember OrganizationMember?
  conversations      Conversation[]      @relation("ConversationParent")
  conversations2     Conversation[]      @relation("ConversationTutor")
  messages           Message[]
  bookings           Booking[]
  reviews            Review[]
  notifications      Notification[]
  payments           Payment[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([status])
  @@map("users")
}

model Parent {
  id     Int @id @default(autoincrement())
  userId Int @unique @map("user_id")

  preferredCommunication String? @map("preferred_communication")
  emergencyContactName   String? @map("emergency_contact_name")
  emergencyContactPhone  String? @map("emergency_contact_phone")

  referralCode String? @unique @map("referral_code")
  referredBy   Int?    @map("referred_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  children Child[]

  @@index([userId])
  @@index([referralCode])
  @@map("parents")
}

model Child {
  id       Int @id @default(autoincrement())
  parentId Int @map("parent_id")

  firstName   String   @map("first_name")
  lastName    String   @map("last_name")
  nickname    String?
  dateOfBirth DateTime @map("date_of_birth")
  gender      Gender?
  avatarUrl   String?  @map("avatar_url")

  gradeLevel Int?    @map("grade_level")
  schoolName String? @map("school_name")

  learningStyle String? @map("learning_style")
  specialNeeds  String? @map("special_needs") @db.Text
  notes         String? @db.Text

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent        Parent         @relation(fields: [parentId], references: [id], onDelete: Cascade)
  bookings      Booking[]
  consultations Consultation[]

  @@index([parentId]) // ⭐ For parent scope
  @@index([dateOfBirth])
  @@map("children")
}

model Tutor {
  id     Int @id @default(autoincrement())
  userId Int @unique @map("user_id")

  // ⭐ CRITICAL: Every tutor belongs to an organization (INDIVIDUAL or COMPANY)
  organizationId Int @map("organization_id")

  bio           String?  @db.Text
  videoIntroUrl String?  @map("video_intro_url")
  university    String?
  major         String?
  year          Int?
  studentIdCard String?  @map("student_id_card")
  gpa           Decimal? @db.Decimal(3, 2)

  englishLevel          String?  @map("english_level")
  ieltsScore            Decimal? @map("ielts_score") @db.Decimal(2, 1)
  englishCertificateUrl String?  @map("english_certificate_url")

  applicationStatus  TutorStatus @default(PENDING) @map("application_status")
  verificationStatus String?     @map("verification_status")

  // Distinguish freelance from employed tutors
  isFreelance Boolean @default(false) @map("is_freelance")

  totalSessions     Int     @default(0) @map("total_sessions")
  completedSessions Int     @default(0) @map("completed_sessions")
  cancelledSessions Int     @default(0) @map("cancelled_sessions")
  totalEarnings     Decimal @default(0) @map("total_earnings") @db.Decimal(15, 2)
  averageRating     Decimal @default(0) @map("average_rating") @db.Decimal(2, 1)
  totalReviews      Int     @default(0) @map("total_reviews")

  bankAccountName   String? @map("bank_account_name")
  bankAccountNumber String? @map("bank_account_number")
  bankName          String? @map("bank_name")
  bankBranch        String? @map("bank_branch")

  teachingExperienceYears Int       @default(0) @map("teaching_experience_years")
  backgroundCheckStatus   String?   @map("background_check_status")
  backgroundCheckDate     DateTime? @map("background_check_date")

  approvedAt DateTime? @map("approved_at")
  approvedBy Int?      @map("approved_by")

  isFeatured Boolean @default(false) @map("is_featured")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  organizationMember OrganizationMember? @relation("TutorOrganizationMember")
  createdProducts    Product[]           @relation("ProductCreatedByTutor")
  bookings           Booking[]
  reviews            Review[]
  subscriptions      Subscription[]
  scheduleSlots      ScheduleSlot[]

  @@index([userId])
  @@index([organizationId]) // ⭐ CRITICAL for scope filtering
  @@index([applicationStatus])
  @@index([isFreelance])
  @@index([isFeatured])
  @@map("tutors")
}

model Organization {
  id          Int              @id @default(autoincrement())
  type        OrganizationType // INDIVIDUAL (freelance) or COMPANY (partner)
  name        String
  nameEn      String?          @map("name_en")
  slug        String           @unique
  description String?          @db.Text

  logoUrl  String? @map("logo_url")
  coverUrl String? @map("cover_url")

  address  String?
  city     String?
  district String?
  ward     String?
  lat      Decimal? @db.Decimal(10, 8)
  lng      Decimal? @db.Decimal(11, 8)

  phone       String?
  email       String?
  website     String?
  facebookUrl String? @map("facebook_url")

  taxCode         String? @map("tax_code")
  businessLicense String? @map("business_license")

  status OrganizationStatus @default(PENDING)

  totalProducts Int     @default(0) @map("total_products")
  totalBookings Int     @default(0) @map("total_bookings")
  averageRating Decimal @default(0) @map("average_rating") @db.Decimal(2, 1)
  totalReviews  Int     @default(0) @map("total_reviews")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members         OrganizationMember[]
  tutors          Tutor[] // ⭐ All tutors (including freelancers) belong to an organization
  products        Product[]
  bookings        Booking[]
  reviews         Review[]
  subscriptions   Subscription[]
  conversations   Conversation[]
  scheduleSlots   ScheduleSlot[]

  @@index([slug])
  @@index([type]) // ⭐ For filtering by org type
  @@index([status])
  @@map("organizations")
}

model OrganizationMember {
  id             Int @id @default(autoincrement())
  userId         Int @unique @map("user_id")
  organizationId Int @map("organization_id")

  role OrganizationMemberRole @default(STAFF)

  // ⭐ Fine-grained permissions (optional, can be expanded)
  canManageProducts  Boolean @default(false) @map("can_manage_products")
  canManageBookings  Boolean @default(false) @map("can_manage_bookings")
  canManageMembers   Boolean @default(false) @map("can_manage_members")
  canViewReports     Boolean @default(false) @map("can_view_reports")

  joinedAt  DateTime @default(now()) @map("joined_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tutor        Tutor?       @relation("TutorOrganizationMember", fields: [userId], references: [userId], map: "organization_members_tutor_user_id_fkey")

  @@index([userId])
  @@index([organizationId])
  @@map("organization_members")
}

// ============================================
// PRODUCT MODELS
// ============================================

model Product {
  id     Int         @id @default(autoincrement())
  type   ProductType
  name   String
  nameEn String?     @map("name_en")
  slug   String      @unique

  description      String  @db.Text
  shortDescription String? @map("short_description") @db.Text

  // Pricing
  price         Decimal   @db.Decimal(10, 2)
  originalPrice Decimal?  @map("original_price") @db.Decimal(10, 2)
  priceUnit     PriceUnit @default(SESSION) @map("price_unit")

  // Duration
  durationMinutes Int  @default(60) @map("duration_minutes")
  totalSessions   Int? @map("total_sessions")

  // Age range
  ageFrom Int? @map("age_from")
  ageTo   Int? @map("age_to")

  // Status
  status ProductStatus @default(DRAFT)

  // Media
  thumbnailUrl String? @map("thumbnail_url")

  // SEO
  metaTitle       String? @map("meta_title")
  metaDescription String? @map("meta_description") @db.Text

  // Sorting
  sortOrder  Int     @default(0) @map("sort_order")
  isFeatured Boolean @default(false) @map("is_featured")

  // ⭐ SINGLE OWNERSHIP: Products belong to Organizations only
  organizationId Int @map("organization_id") // REQUIRED, NOT NULL

  // Optional: Track who created the product (for audit/display)
  createdByTutorId Int? @map("created_by_tutor_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdByTutor   Tutor?            @relation("ProductCreatedByTutor", fields: [createdByTutorId], references: [id], onDelete: SetNull)
  categories       ProductCategory[]
  images           ProductImage[]
  bookings         Booking[]
  reviews          Review[]
  consultations    Consultation[]

  @@index([slug])
  @@index([type])
  @@index([status])
  @@index([organizationId]) // ⭐ CRITICAL for scope filtering
  @@index([organizationId, status]) // ⭐ Composite index for common queries
  @@index([createdByTutorId])
  @@index([isFeatured])
  @@map("products")
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String
  nameEn String? @map("name_en")
  slug   String  @unique

  description String? @db.Text
  iconUrl     String? @map("icon_url")

  parentId Int? @map("parent_id")

  sortOrder Int     @default(0) @map("sort_order")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent   Category?         @relation("CategoryParent", fields: [parentId], references: [id])
  children Category[]        @relation("CategoryParent")
  products ProductCategory[]

  @@index([slug])
  @@index([parentId])
  @@map("categories")
}

model ProductCategory {
  id         Int @id @default(autoincrement())
  productId  Int @map("product_id")
  categoryId Int @map("category_id")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@map("product_categories")
}

model ProductImage {
  id        Int @id @default(autoincrement())
  productId Int @map("product_id")

  url       String
  alt       String?
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ============================================
// CONSULTATION & COMMUNICATION MODELS
// ============================================

model Conversation {
  id Int @id @default(autoincrement())

  parentId       Int  @map("parent_id")
  tutorId        Int? @map("tutor_id")
  organizationId Int? @map("organization_id")

  // Last message info
  lastMessageId Int?      @map("last_message_id")
  lastMessageAt DateTime? @map("last_message_at")

  // Unread counts
  parentUnreadCount Int @default(0) @map("parent_unread_count")
  tutorUnreadCount  Int @default(0) @map("tutor_unread_count")

  status ConversationStatus @default(ACTIVE)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent        User           @relation("ConversationParent", fields: [parentId], references: [id])
  tutor         User?          @relation("ConversationTutor", fields: [tutorId], references: [id])
  organization  Organization?  @relation(fields: [organizationId], references: [id])
  messages      Message[]
  consultations Consultation[]

  @@index([parentId]) // ⭐ For parent scope
  @@index([tutorId])
  @@index([organizationId]) // ⭐ For organization scope
  @@index([status])
  @@map("conversations")
}

model Message {
  id             Int @id @default(autoincrement())
  conversationId Int @map("conversation_id")
  senderId       Int @map("sender_id")

  content String      @db.Text
  type    MessageType @default(TEXT)

  // For attachments
  attachments Json?

  // Read status
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model Consultation {
  id Int @id @default(autoincrement())

  conversationId Int  @map("conversation_id")
  productId      Int? @map("product_id")

  // Consultation details
  childId       Int?      @map("child_id")
  preferredDate DateTime? @map("preferred_date")
  preferredTime String?   @map("preferred_time")
  notes         String?   @db.Text

  status ConsultationStatus @default(PENDING)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  product      Product?     @relation(fields: [productId], references: [id])
  child        Child?       @relation(fields: [childId], references: [id])
  booking      Booking?     @relation("ConsultationBooking")

  @@index([conversationId])
  @@index([productId])
  @@index([status])
  @@map("consultations")
}

// ============================================
// BOOKING & SCHEDULE MODELS
// ============================================

model Booking {
  id          Int    @id @default(autoincrement())
  bookingCode String @unique @map("booking_code")

  parentId  Int @map("parent_id")
  childId   Int @map("child_id")
  productId Int @map("product_id")

  // ⭐ Provider side: Organization provides service, Tutor executes
  organizationId Int  @map("organization_id") // REQUIRED - which org provides service
  tutorId        Int? @map("tutor_id")        // Optional - assigned tutor (can be null initially)

  consultationId Int? @unique @map("consultation_id")

  // Schedule
  scheduledDate   DateTime @map("scheduled_date")
  scheduledTime   String   @map("scheduled_time")
  durationMinutes Int      @default(60) @map("duration_minutes")

  // Location
  locationType    LocationType @default(ONLINE) @map("location_type")
  locationAddress String?      @map("location_address")
  locationLat     Decimal?     @map("location_lat") @db.Decimal(10, 8)
  locationLng     Decimal?     @map("location_lng") @db.Decimal(11, 8)
  locationNotes   String?      @map("location_notes") @db.Text

  // Status
  status BookingStatus @default(PENDING)

  // Pricing
  totalPrice   Decimal  @map("total_price") @db.Decimal(10, 2)
  platformFee  Decimal? @map("platform_fee") @db.Decimal(10, 2)
  tutorEarning Decimal? @map("tutor_earning") @db.Decimal(10, 2)

  // Session tracking
  checkInTime           DateTime? @map("check_in_time")
  checkInPhotoUrl       String?   @map("check_in_photo_url")
  checkOutTime          DateTime? @map("check_out_time")
  actualDurationMinutes Int?      @map("actual_duration_minutes")

  // Cancellation
  cancellationReason String?   @map("cancellation_reason") @db.Text
  cancelledBy        Int?      @map("cancelled_by")
  cancelledAt        DateTime? @map("cancelled_at")

  // Notes
  parentNotes String? @map("parent_notes") @db.Text
  tutorNotes  String? @map("tutor_notes") @db.Text
  adminNotes  String? @map("admin_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent       User         @relation(fields: [parentId], references: [id])
  child        Child        @relation(fields: [childId], references: [id])
  product      Product      @relation(fields: [productId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  tutor        Tutor?       @relation(fields: [tutorId], references: [id], onDelete: SetNull)
  consultation Consultation? @relation("ConsultationBooking", fields: [consultationId], references: [id])
  payment      Payment?     @relation("BookingPayment")
  review       Review?      @relation("BookingReview")
  schedules    Schedule[]

  @@index([bookingCode])
  @@index([parentId]) // ⭐ For parent scope
  @@index([childId])
  @@index([productId])
  @@index([organizationId]) // ⭐ CRITICAL for organization scope
  @@index([organizationId, status]) // ⭐ Composite index for common queries
  @@index([organizationId, scheduledDate]) // ⭐ For schedule queries
  @@index([tutorId]) // ⭐ For tutor's assigned bookings
  @@index([tutorId, scheduledDate]) // ⭐ For tutor's calendar
  @@index([scheduledDate])
  @@index([status])
  @@map("bookings")
}

model Schedule {
  id        Int @id @default(autoincrement())
  bookingId Int @map("booking_id")

  date      DateTime
  startTime String   @map("start_time")
  endTime   String   @map("end_time")

  status ScheduleStatus @default(SCHEDULED)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([date])
  @@index([status])
  @@map("schedules")
}

model ScheduleSlot {
  id Int @id @default(autoincrement())

  tutorId        Int? @map("tutor_id")
  organizationId Int? @map("organization_id")

  dayOfWeek Int    @map("day_of_week") // 0-6 (Sunday-Saturday)
  startTime String @map("start_time")
  endTime   String @map("end_time")

  isAvailable Boolean @default(true) @map("is_available")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tutor        Tutor?        @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([organizationId])
  @@index([dayOfWeek])
  @@map("schedule_slots")
}

// ============================================
// CONTENT MANAGEMENT MODELS
// ============================================

model Banner {
  id Int @id @default(autoincrement())

  title       String
  description String? @db.Text

  imageUrl String          @map("image_url")
  linkUrl  String?         @map("link_url")
  linkType BannerLinkType? @map("link_type")

  // Display settings
  position  BannerPosition @default(HOME)
  sortOrder Int            @default(0) @map("sort_order")

  // Status
  status BannerStatus @default(ACTIVE)

  // Date range
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([position])
  @@index([status])
  @@index([startDate, endDate])
  @@map("banners")
}

model Notification {
  id Int @id @default(autoincrement())

  userId Int? @map("user_id") // null = broadcast to all

  title   String
  content String @db.Text

  type NotificationType
  data Json? // Additional data

  // Read status
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  // Delivery
  sentAt DateTime? @map("sent_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Review {
  id Int @id @default(autoincrement())

  parentId       Int  @map("parent_id")
  productId      Int? @map("product_id")
  tutorId        Int? @map("tutor_id")
  organizationId Int? @map("organization_id")
  bookingId      Int? @unique @map("booking_id")

  rating Int // 1-5

  title   String?
  content String? @db.Text

  // Images
  images Json?

  // Status
  status ReviewStatus @default(PENDING)

  // Response
  response    String?   @db.Text
  respondedBy Int?      @map("responded_by")
  respondedAt DateTime? @map("responded_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  parent       User          @relation(fields: [parentId], references: [id])
  product      Product?      @relation(fields: [productId], references: [id])
  tutor        Tutor?        @relation(fields: [tutorId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  booking      Booking?      @relation("BookingReview", fields: [bookingId], references: [id])

  @@index([parentId]) // ⭐ For parent scope (who wrote the review)
  @@index([productId])
  @@index([tutorId])
  @@index([organizationId]) // ⭐ For organization scope (reviews about them)
  @@index([bookingId])
  @@index([rating])
  @@index([status])
  @@map("reviews")
}

// ============================================
// PAYMENT & SUBSCRIPTION MODELS
// ============================================

model SubscriptionPackage {
  id Int @id @default(autoincrement())

  name        String
  nameEn      String? @map("name_en")
  description String? @db.Text

  // Pricing
  price        Decimal @db.Decimal(10, 2)
  durationDays Int     @map("duration_days")

  // Features (JSON)
  features Json?

  // Limits
  maxProducts     Int? @map("max_products")
  maxBookings     Int? @map("max_bookings")
  maxStaffMembers Int? @map("max_staff_members")

  // Status
  status PackageStatus @default(ACTIVE)

  sortOrder Int @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions Subscription[]

  @@index([status])
  @@map("subscription_packages")
}

model Subscription {
  id Int @id @default(autoincrement())

  tutorId        Int? @map("tutor_id")
  organizationId Int? @map("organization_id")
  packageId      Int  @map("package_id")

  // Status
  status SubscriptionStatus @default(ACTIVE)

  // Dates
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // Auto-renewal
  autoRenew Boolean @default(false) @map("auto_renew")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  tutor        Tutor?              @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  organization Organization?       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  package      SubscriptionPackage @relation(fields: [packageId], references: [id])
  payments     Payment[]

  @@index([tutorId])
  @@index([organizationId])
  @@index([packageId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Payment {
  id Int @id @default(autoincrement())

  userId         Int? @map("user_id")
  bookingId      Int? @unique @map("booking_id")
  subscriptionId Int? @map("subscription_id")

  // Amount
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("VND")

  // Payment method
  method        PaymentMethod
  methodDetails Json?         @map("method_details")

  // Status
  status PaymentStatus @default(PENDING)

  // Transaction info
  transactionId   String? @unique @map("transaction_id")
  gatewayResponse Json?   @map("gateway_response")

  // Dates
  paidAt DateTime? @map("paid_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User?         @relation(fields: [userId], references: [id])
  booking      Booking?      @relation("BookingPayment", fields: [bookingId], references: [id])
  subscription Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId]) // ⭐ For user scope
  @@index([bookingId]) // ⭐ For organization scope (via booking.organizationId)
  @@index([subscriptionId])
  @@index([status])
  @@index([transactionId])
  @@index([createdAt])
  @@map("payments")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  PARENT
  TUTOR
  PARTNER_STAFF
  PARTNER_ADMIN
  KIGGLE_STAFF
  KIGGLE_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum TutorStatus {
  PENDING
  UNDER_REVIEW
  INTERVIEW_SCHEDULED
  TRAINING
  APPROVED
  REJECTED
  INACTIVE
}

enum OrganizationType {
  INDIVIDUAL // Freelance tutor (virtual organization for single person)
  COMPANY    // Actual organization (partner/education center with multiple staff)
}

enum OrganizationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  INACTIVE
}

enum OrganizationMemberRole {
  STAFF
  ADMIN
}

enum ProductType {
  COURSE
  TUTORING_SERVICE
}

enum ProductStatus {
  DRAFT
  PENDING
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum PriceUnit {
  SESSION
  MONTH
  COURSE
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  BLOCKED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum ConsultationStatus {
  PENDING
  ACCEPTED
  REJECTED
  COMPLETED
}

enum LocationType {
  ONLINE
  AT_HOME
  AT_PARTNER
  OTHER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_PARENT
  CANCELLED_BY_TUTOR
  CANCELLED_BY_ORGANIZATION
  CANCELLED_BY_ADMIN
  NO_SHOW_PARENT
  NO_SHOW_TUTOR
  RESCHEDULED
}

enum ScheduleStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BannerPosition {
  HOME
  COURSE_LIST
  TUTORING_LIST
  PROFILE
}

enum BannerLinkType {
  PRODUCT
  CATEGORY
  EXTERNAL
  NONE
}

enum BannerStatus {
  ACTIVE
  INACTIVE
}

enum NotificationType {
  BOOKING
  MESSAGE
  PAYMENT
  REVIEW
  SYSTEM
  PROMOTION
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

enum PackageStatus {
  ACTIVE
  INACTIVE
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  E_WALLET
  CREDIT_CARD
  CASH
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}
